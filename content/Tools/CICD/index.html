<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>GitLab + Docker 快速搭建 CI/CD 自动化部署 | blogs</title>
    <meta name="description" content="专注于前端技术的总结，努力做一名知识的传播者">
    <meta name="generator" content="VitePress v1.1.0">
    <link rel="preload stylesheet" href="/assets/style.BEO0WfyJ.css" as="style">
    
    <script type="module" src="/assets/app.4vbXZhgX.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/framework.DwDoyBw8.js">
    <link rel="modulepreload" href="/assets/chunks/theme.DjpYJe0-.js">
    <link rel="modulepreload" href="/assets/content_Tools_CICD_index.md.DNVLEnYu.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-5d98c3a5><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0f60ec36></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0f60ec36> Skip to content </a><!--]--><!----><header class="VPNav" data-v-5d98c3a5 data-v-ae24b3ad><div class="VPNavBar has-sidebar top" data-v-ae24b3ad data-v-ccf7ddec><div class="wrapper" data-v-ccf7ddec><div class="container" data-v-ccf7ddec><div class="title" data-v-ccf7ddec><div class="VPNavBarTitle has-sidebar" data-v-ccf7ddec data-v-ab179fa1><a class="title" href="/" data-v-ab179fa1><!--[--><!--]--><!----><span data-v-ab179fa1>blogs</span><!--[--><!--]--></a></div></div><div class="content" data-v-ccf7ddec><div class="content-body" data-v-ccf7ddec><!--[--><!--]--><div class="VPNavBarSearch search" data-v-ccf7ddec><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-ccf7ddec data-v-7f418b0f><span id="main-nav-aria-label" class="visually-hidden" data-v-7f418b0f>Main Navigation</span><!--[--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-7f418b0f data-v-b6c34ac9><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-b6c34ac9><span class="text" data-v-b6c34ac9><!----><span data-v-b6c34ac9>关于我</span><span class="vpi-chevron-down text-icon" data-v-b6c34ac9></span></span></button><div class="menu" data-v-b6c34ac9><div class="VPMenu" data-v-b6c34ac9 data-v-e7ea1737><div class="items" data-v-e7ea1737><!--[--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link vp-external-link-icon" href="https://canuse-ui.github.io/canuse" target="_blank" rel="noreferrer" data-v-43f1e123><!--[-->组件库<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-ccf7ddec data-v-e6aabb21><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-e6aabb21 data-v-d1f28634 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-d1f28634></span><span class="vpi-moon moon" data-v-d1f28634></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-ccf7ddec data-v-0394ad82 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/vuejs/vitepress" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-eee4e7cb><span class="vpi-social-github" /></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-ccf7ddec data-v-d0bd9dde data-v-b6c34ac9><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-b6c34ac9><span class="vpi-more-horizontal icon" data-v-b6c34ac9></span></button><div class="menu" data-v-b6c34ac9><div class="VPMenu" data-v-b6c34ac9 data-v-e7ea1737><!----><!--[--><!--[--><!----><div class="group" data-v-d0bd9dde><div class="item appearance" data-v-d0bd9dde><p class="label" data-v-d0bd9dde>Appearance</p><div class="appearance-action" data-v-d0bd9dde><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-d0bd9dde data-v-d1f28634 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-d1f28634></span><span class="vpi-moon moon" data-v-d1f28634></span><!--]--></span></span></button></div></div></div><div class="group" data-v-d0bd9dde><div class="item social-links" data-v-d0bd9dde><div class="VPSocialLinks social-links-list" data-v-d0bd9dde data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/vuejs/vitepress" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-eee4e7cb><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-ccf7ddec data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-ccf7ddec><div class="divider-line" data-v-ccf7ddec></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-5d98c3a5 data-v-a6f0e41e><div class="container" data-v-a6f0e41e><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-a6f0e41e><span class="vpi-align-left menu-icon" data-v-a6f0e41e></span><span class="menu-text" data-v-a6f0e41e>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-a6f0e41e data-v-267dd0ed><button data-v-267dd0ed>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-5d98c3a5 data-v-575e6a36><div class="curtain" data-v-575e6a36></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-575e6a36><span class="visually-hidden" id="sidebar-aria-label" data-v-575e6a36> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-575e6a36><section class="VPSidebarItem level-0 has-active" data-v-575e6a36 data-v-b8d55f3b><div class="item" role="button" tabindex="0" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><h2 class="text" data-v-b8d55f3b>show all page</h2><!----></div><div class="items" data-v-b8d55f3b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/guide/" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>Guide</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/content/JavaScript/" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>JavaScript</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/content/Css/" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>CSS</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/content/Vue/" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>Vue</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/content/React/" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>React</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/content/Webpack/" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>Webpack</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/content/Electron/" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>Electron</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/content/Http/" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>HTTP</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/content/Concept/" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>概念详解</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/content/Principle/" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>原理分析</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/content/Performance/" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>性能优化</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/content/Problem/" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>疑难杂症</p><!--]--></a><!----></div><!----></div><section class="VPSidebarItem level-1" data-v-b8d55f3b data-v-b8d55f3b><div class="item" role="button" tabindex="0" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><h3 class="text" data-v-b8d55f3b>源码</h3><!----></div><div class="items" data-v-b8d55f3b><!--[--><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/content/Source/Javascript/" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>Javascript</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/content/Source/Vue/Vue2/" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>Vue2源码学习</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/content/Source/Vue/Internal/" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>vue内部运行机制</p><!--]--></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1 has-active" data-v-b8d55f3b data-v-b8d55f3b><div class="item" role="button" tabindex="0" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><h3 class="text" data-v-b8d55f3b>工具</h3><!----></div><div class="items" data-v-b8d55f3b><!--[--><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/content/Tools/Picgo/" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>PicGo图床</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/content/Tools/CICD/" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>CI/CD</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/content/Tools/BTQL/" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>宝塔面板+青龙面板</p><!--]--></a><!----></div><!----></div><!--]--></div></section><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-5d98c3a5 data-v-1428d186><div class="VPDoc has-sidebar has-aside" data-v-1428d186 data-v-39a288b8><!--[--><!--]--><div class="container" data-v-39a288b8><div class="aside" data-v-39a288b8><div class="aside-curtain" data-v-39a288b8></div><div class="aside-container" data-v-39a288b8><div class="aside-content" data-v-39a288b8><div class="VPDocAside" data-v-39a288b8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-3f215769 data-v-935f8a84><div class="content" data-v-935f8a84><div class="outline-marker" data-v-935f8a84></div><div class="outline-title" role="heading" aria-level="2" data-v-935f8a84>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-935f8a84><span class="visually-hidden" id="doc-outline-aria-label" data-v-935f8a84> Table of Contents for current page </span><ul class="VPDocOutlineItem root" data-v-935f8a84 data-v-b933a997><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-39a288b8><div class="content-container" data-v-39a288b8><!--[--><!--]--><main class="main" data-v-39a288b8><div style="position:relative;" class="vp-doc _content_Tools_CICD_" data-v-39a288b8><div><h1 id="gitlab-docker-快速搭建-ci-cd-自动化部署" tabindex="-1">GitLab + Docker 快速搭建 CI/CD 自动化部署 <a class="header-anchor" href="#gitlab-docker-快速搭建-ci-cd-自动化部署" aria-label="Permalink to &quot;GitLab + Docker 快速搭建 CI/CD 自动化部署&quot;">​</a></h1><h2 id="什么是持续化集成" tabindex="-1">什么是持续化集成? <a class="header-anchor" href="#什么是持续化集成" aria-label="Permalink to &quot;什么是持续化集成?&quot;">​</a></h2><h3 id="ci" tabindex="-1">CI <a class="header-anchor" href="#ci" aria-label="Permalink to &quot;CI&quot;">​</a></h3><p>在持续集成环境中，开发人员将会频繁的提交代码到主干。这些新提交在最终合并到主线之前，都需要通过编译和自动化测试进行验证。这样做是基于之前持续集成过程中很重视自动化测试验证结果，以保障所有的提交在合并主干之后的质量问题，对可能出现的一些问题进行预计。</p><h3 id="持续交付" tabindex="-1">持续交付 <a class="header-anchor" href="#持续交付" aria-label="Permalink to &quot;持续交付&quot;">​</a></h3><p>持续交付就是讲我们的应用发布出去的过程。这个过程可以确保我们尽量可能快的实现交付。这就意味着除了自动化测试，我们还需要有自动化的发布流，以及通过一个按键就可以随时随地地实现应用的部署上线</p><p>通过持续交付，可以决定每天，每周，每两周发布一次，这完全可以根据自己的业务进行设置</p><p>但是，如果你真的希望体验持续交付的优势，就需要先进行小批量发布，尽快部署到生产线，以便在出现问题时方便进行故障排除</p><h3 id="持续部署" tabindex="-1">持续部署 <a class="header-anchor" href="#持续部署" aria-label="Permalink to &quot;持续部署&quot;">​</a></h3><p>如果我们想更加深入一步的话，就是持续部署了。通过这个方式，任何修改通过了所有已有的工作流就会直接和客户见面。没有人为干预（没有一键部署按钮），只有当一个修改在工作流中构建失败才能阻止它部署到产品线</p><p>持续部署是一个很优秀的方式，可以加速与客户的反馈循环，但是会给团队带来压力，因为不再有“发布日”了。开发人员可以专注于构建软件，他们看到他们修改在完成工作后几分钟就上线了。基本上，当开发人员在主分支合并一个提交时，这个分支将被构建，测试，如果一切顺利，则会部署到生产环境中。</p><h3 id="持续集成需求的必要性" tabindex="-1">持续集成需求的必要性 <a class="header-anchor" href="#持续集成需求的必要性" aria-label="Permalink to &quot;持续集成需求的必要性&quot;">​</a></h3><ul><li>持续集成是通过平台串联各个开发环节，实现和沉淀工作自动化的方法</li><li>线上代码和代码仓库不同步，影响迭代和团队协作</li><li>静态资源发布依赖人工，浪费开发人力</li><li>缺少自动化测试，产品质量得不到保障</li><li>文案简单修改上线，需要技术介入</li></ul><p><img src="https://cdn.jsdelivr.net/gh/fqcto/images/blogs/picture/20211129154803.png" alt="持续集成需求"></p><h2 id="gitlab" tabindex="-1">Gitlab <a class="header-anchor" href="#gitlab" aria-label="Permalink to &quot;Gitlab&quot;">​</a></h2><p>Gitlab是一个开源的版本管理系统，实现一个自托管的Git项目仓库，可通过 WEB 界面进行访问公开的或者私人项目。它拥有与Github类似的功能，能够浏览源码，管理缺陷和注释，可以管理团队对仓库的访问，它非常易于浏览提交的版本并提供一个文件历史库。团队成员可以利用内置的简单的聊天程序进行交流。它还提供一个代码片段收集功能可以实现代码复用。</p><p>GitLab对于系统性能有要求，所以我们需要将克隆出来的虚拟机的内存提高到至少2G以上。</p><h3 id="gitlab-安装" tabindex="-1">Gitlab 安装 <a class="header-anchor" href="#gitlab-安装" aria-label="Permalink to &quot;Gitlab 安装&quot;">​</a></h3><p><strong>方法一：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo docker run --detach \</span></span>
<span class="line"><span>--hostname localhost \</span></span>
<span class="line"><span>--publish 443:443 --publish 8084:8084 --publish 222:22 \</span></span>
<span class="line"><span>--name gitlab \</span></span>
<span class="line"><span>--restart always \</span></span>
<span class="line"><span>--volume /home/docker/gitlab/config:/etc/gitlab \</span></span>
<span class="line"><span>--volume /home/docker/gitlab/logs:/var/log/gitlab \</span></span>
<span class="line"><span>--volume /home/docker/gitlab/data:/var/opt/gitlab \</span></span>
<span class="line"><span>gitlab/gitlab-ce:latest</span></span></code></pre></div><p>localhost:主机名，即虚拟机的ip，8084可以自己定义端口号，restart重启方式，volume目录挂载，gitlab/gitlab-ce:latest镜像名</p><p><strong>方法二：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>  docker pull twang2218/gitlab-ce-zh</span></span></code></pre></div><p>等待其拉取，然后在 /home 下新建docker 目录，再在其下新建 gitlab 目录，进入 gitlab 目录，在当前目录下新建 docker-compose.yml配置文件，编写内容如下。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>version: &#39;3&#39;</span></span>
<span class="line"><span>services:</span></span>
<span class="line"><span>  web:</span></span>
<span class="line"><span>    image:  &#39;twang2218/gitlab-ce-zh&#39;  #gitlab镜像</span></span>
<span class="line"><span>    restart:  always</span></span>
<span class="line"><span>    privileged: true  #权限</span></span>
<span class="line"><span>    hostname: &#39;&#39;  #主机名，即虚拟机的ip</span></span>
<span class="line"><span>    environment:</span></span>
<span class="line"><span>      TZ: &#39;Asia/Shanghai&#39;,</span></span>
<span class="line"><span>      GITLAB_OMNIBUS_CONFIG: |</span></span>
<span class="line"><span>        external_url  &#39;&#39;  #主机名，即虚拟机的ip</span></span>
<span class="line"><span>        gitlab_rails[&#39;gitlab_shell_ssh_port&#39;] = 2222</span></span>
<span class="line"><span>        unicorn[&#39;port&#39;] = 8888</span></span>
<span class="line"><span>        nginx[&#39;listen_port&#39;] = 8084</span></span>
<span class="line"><span>    ports:</span></span>
<span class="line"><span>      - &#39;8084:8084&#39;</span></span>
<span class="line"><span>      - &#39;8443:443&#39;</span></span>
<span class="line"><span>      - &#39;2222:22&#39;</span></span>
<span class="line"><span>    volumes:</span></span>
<span class="line"><span>      - &#39;./config:/etc/gitlab&#39;</span></span>
<span class="line"><span>      - &#39;./logs:/var/log/gitlab&#39;</span></span>
<span class="line"><span>      - &#39;./data:/var/opt/gitlab&#39;</span></span></code></pre></div><p>执行 <code>docker-compose up</code>，然后进入等待时间，等它下好了去通过自己设置的虚拟机的ip和端口号访问</p><p><img src="https://cdn.jsdelivr.net/gh/fqcto/images/blogs/picture/20211129160440.png" alt="GitLab 中文社区版"></p><p>如果安装过程中有报错权限问题，那么加上 <code>privileged: true</code></p><p>查看方式：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>root@iZm5ebvlfc3n55vzckl9ifZ:# docker ps</span></span>
<span class="line"><span>CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS                 PORTS                                                                         NAMES</span></span>
<span class="line"><span>ddc7d0e214ef        twang2218/gitlab-ce-zh        &quot;/assets/wrapper&quot;        30 hours ago        Up 6 hours (healthy)   80/tcp, 0.0.0.0:8084-&gt;8084/tcp, 0.0.0.0:2222-&gt;22/tcp, 0.0.0.0:8443-&gt;443/tcp   gitlab_web_1</span></span></code></pre></div><p>通过虚拟主机的 <code>ip</code> + <code>端口</code> 访问，此时需要设置管理员密码，账号为root，密码最少为8位。</p><p>登录成功后，如下：</p><p><img src="https://cdn.jsdelivr.net/gh/fqcto/images/blogs/picture/20211129160835.png" alt="项目创建"></p><h3 id="项目创建" tabindex="-1">项目创建 <a class="header-anchor" href="#项目创建" aria-label="Permalink to &quot;项目创建&quot;">​</a></h3><p>点击 <code>+</code> 号 =&gt; <code>新建项目</code></p><p><img src="https://cdn.jsdelivr.net/gh/fqcto/images/blogs/picture/20211129160952.png" alt="新建项目"></p><p>输入项目名称及描述信息，设置可见等级：私有，内部，公开。</p><p><img src="https://cdn.jsdelivr.net/gh/fqcto/images/blogs/picture/20211129161043.png" alt="新建项目规范"></p><p><strong>初始化项目</strong></p><p>我们可以选择通过增加一个 README 的方式来初始化项目，如下：</p><p><img src="https://cdn.jsdelivr.net/gh/fqcto/images/blogs/picture/20211129161205.png" alt="初始化README"></p><p><img src="https://cdn.jsdelivr.net/gh/fqcto/images/blogs/picture/20211129161233.png" alt="提交修改README"></p><p>创建项目的时候有一个问题，在自己最开始定义了端口号，创建项目的时候会没有端口号，这时候clone项目的时候会访问不了，这时候我们在最开始安装定义目录里面config目录下找到 <code>gitlab.rb</code>，编辑它，搜索 <code>external_url</code>，没有就添加 <code>external_url:主机ip+端口号</code>,有就修改就行了。这时候我们就可以去克隆项目了。当然我们也可以通过下面方法去把项目推送到gitlab上面：</p><p><img src="https://cdn.jsdelivr.net/gh/fqcto/images/blogs/picture/20211129161627.png" alt="git推送命令"></p><p><img src="https://cdn.jsdelivr.net/gh/fqcto/images/blogs/picture/20211129161741.png" alt="项目git面板"></p><h2 id="gitlab-runner" tabindex="-1">Gitlab-Runner <a class="header-anchor" href="#gitlab-runner" aria-label="Permalink to &quot;Gitlab-Runner&quot;">​</a></h2><h3 id="安装" tabindex="-1">安装 <a class="header-anchor" href="#安装" aria-label="Permalink to &quot;安装&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo docker run -d --name gitlab-runner --restart always \</span></span>
<span class="line"><span>  -v /home/gitlab-runner/config:/etc/gitlab-runner \</span></span>
<span class="line"><span>  -v /var/run/docker.sock:/var/run/docker.sock \</span></span>
<span class="line"><span>  gitlab/gitlab-runner:latest</span></span></code></pre></div><p>映射 <code>/var/run/docker.sock</code> 这个文件是为了让容器可以通过 <code>/var/run/docker.sock</code> 与 <code>Docker</code> 守护进程通信，管理其他 <code>Docker</code> 容器 <code>-v /home/gitlab-runner/config:/etc/gitlab-runner</code> 是将runner的配置文件映射到宿主机 <code>/home/gitlab-runner/config</code> 方便调整和查看配置</p><p>安装完成我们需要去注册 Gitlab-Runner</p><p>运行 <code>docker ps</code> 查看：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>root@iZm5ebvlfc3n55vzckl9ifZ:/home/docker/gitlab# docker ps</span></span>
<span class="line"><span>CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS                 PORTS                                                                         NAMES</span></span>
<span class="line"><span>ed6c7a038263        gitlab/gitlab-runner:latest   &quot;/usr/bin/dumb-init …&quot;   24 hours ago        Up 24 hours                                                                                          gitlab-runner</span></span>
<span class="line"><span>ddc7d0e214ef        twang2218/gitlab-ce-zh        &quot;/assets/wrapper&quot;        30 hours ago        Up 6 hours (healthy)   80/tcp, 0.0.0.0:8084-&gt;8084/tcp, 0.0.0.0:2222-&gt;22/tcp, 0.0.0.0:8443-&gt;443/tcp   gitlab_web_1</span></span></code></pre></div><h3 id="注册" tabindex="-1">注册 <a class="header-anchor" href="#注册" aria-label="Permalink to &quot;注册&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>docker run --rm -v /srv/gitlab-runner/config:/etc/gitlab-runner gitlab/gitlab-runner register \</span></span>
<span class="line"><span>  --non-interactive \</span></span>
<span class="line"><span>  --executor &quot;docker&quot; \</span></span>
<span class="line"><span>  --docker-image alpine:latest \</span></span>
<span class="line"><span>  --url &quot;&quot; \</span></span>
<span class="line"><span>  --registration-token &quot;&quot; \</span></span>
<span class="line"><span>  --description &quot;first-register-runner&quot; \</span></span>
<span class="line"><span>  --tag-list &quot;vue3-app&quot; \</span></span>
<span class="line"><span>  --run-untagged=&quot;true&quot; \</span></span>
<span class="line"><span>  --locked=&quot;false&quot; \</span></span>
<span class="line"><span>  --access-level=&quot;not_protected&quot;</span></span></code></pre></div><p>注册需要输出 <code>url</code>, <code>token</code>, <code>描述</code>, <code>tag</code>, <code>执行器</code> 等，<code>url</code> 和 <code>token</code> 怎么来的呢?在设置 -&gt; CI/CD -&gt; Runner 里面，我这里面注册了一个专用的和共享的 <code>Runner</code>, 正常情况我们用专门 <code>Runner</code> 就可以了。共享版 <code>Runner</code> 是登陆 <code>root</code> 账户在头部小扳手图片里面的 <code>Runner</code> 得到 <code>url</code> 和 <code>token</code>, 然后去注册。这里面的tag值会在编写 <code>.gitlab-ci.yml</code> 时用到。</p><p><img src="https://cdn.jsdelivr.net/gh/fqcto/images/blogs/picture/20211129162650.png" alt="Runner配置"></p><h3 id="运行流水线" tabindex="-1">运行流水线 <a class="header-anchor" href="#运行流水线" aria-label="Permalink to &quot;运行流水线&quot;">​</a></h3><p>在项目根目录里面创建一个 <code>.gitlab-ci.yml</code>，编写代码如下：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>image: node:alpine</span></span>
<span class="line"><span></span></span>
<span class="line"><span>stages: # 分段</span></span>
<span class="line"><span>  - install</span></span>
<span class="line"><span>  - eslint</span></span>
<span class="line"><span>  - build</span></span>
<span class="line"><span>  - deploy</span></span>
<span class="line"><span></span></span>
<span class="line"><span>cache: # 缓存</span></span>
<span class="line"><span>  paths:</span></span>
<span class="line"><span>    - node_modules</span></span>
<span class="line"><span></span></span>
<span class="line"><span>job_install:</span></span>
<span class="line"><span>  tags:</span></span>
<span class="line"><span>    - vue3-app</span></span>
<span class="line"><span>  stage: install</span></span>
<span class="line"><span>  script:</span></span>
<span class="line"><span>    - npm install</span></span>
<span class="line"><span></span></span>
<span class="line"><span>job_build:</span></span>
<span class="line"><span>  tags:</span></span>
<span class="line"><span>    - vue3-app</span></span>
<span class="line"><span>  stage: build</span></span>
<span class="line"><span>  script:</span></span>
<span class="line"><span>    - npm run build</span></span></code></pre></div><p>参数说明：</p><ul><li>stages:pipeline的阶段列表，定义整个pipeline阶段</li><li>stage:定义某个job的所在阶段</li><li>image:指定一个基础Docker进行作为基础运行环境，比如:node,python,java</li><li>tags:用于指定Runner，tags的取值范围是在该项目可惜可见的runner tags中，也就是前面我们设置的那个tag</li><li>only/except:知道当前任务条件</li><li>when:实现在发生故障时仍能运行的作业</li><li>cache:讲当前工作环境目录中的一些文件，文件夹存储起来，用于在各个任务初始化的时候恢复</li><li>environment:指定部署相关任务的环境，并非真实环境，是对要部署到某环境的任务的归类。方便在gitlab上聚合以便进行回滚和重新部署操作</li><li>artifacts:保留文档。在每次 job 之前runner会清除未被 git 跟踪的文件。为了让编译或其他操作后的产物可以留存到后续使用，添加该参数并设置保留的目录，保留时间等。被保留的文件将被上传到gitlab以备后续使用。</li><li>dependencies:任务依赖。指定job的前置job。添加该参数后，可以获取到前置job的artifacts。注意如果前置 job 执行失败，导致没能生成artifacts，则 job 也会直接失败。</li></ul><p>编写好上面代码后推送到gitlab后就会执行里面的语句：</p><p><img src="https://cdn.jsdelivr.net/gh/fqcto/images/blogs/picture/20211129165647.png" alt="CI/CD作业"></p><h3 id="部署" tabindex="-1">部署 <a class="header-anchor" href="#部署" aria-label="Permalink to &quot;部署&quot;">​</a></h3><p>在项目中创建一个 <code>Dockerfile</code>，代码如下：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>FROM node:latest as builder</span></span>
<span class="line"><span>WORKDIR /app</span></span>
<span class="line"><span>COPY  package.json</span></span>
<span class="line"><span>RUN npm install --registry=http://registry.npm.taobao.org</span></span>
<span class="line"><span>COPY ..</span></span>
<span class="line"><span>RUN npm run build</span></span>
<span class="line"><span></span></span>
<span class="line"><span>FROM nginx:latest</span></span>
<span class="line"><span>COPY --from=builder /app/dist /usr/share/nginx/html</span></span></code></pre></div><p><code>.gitlab-ci.yml</code> 修改如下：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>image: node:alpine</span></span>
<span class="line"><span></span></span>
<span class="line"><span>stages: # 分段</span></span>
<span class="line"><span>  - install</span></span>
<span class="line"><span>  - eslint</span></span>
<span class="line"><span>  - build</span></span>
<span class="line"><span>  - deploy</span></span>
<span class="line"><span></span></span>
<span class="line"><span>cache: # 缓存</span></span>
<span class="line"><span>  paths:</span></span>
<span class="line"><span>    - node_modules</span></span>
<span class="line"><span></span></span>
<span class="line"><span>job_install:</span></span>
<span class="line"><span>  tags:</span></span>
<span class="line"><span>    - vue3-app</span></span>
<span class="line"><span>  stage: install</span></span>
<span class="line"><span>  script:</span></span>
<span class="line"><span>    - npm install</span></span>
<span class="line"><span></span></span>
<span class="line"><span>job_build:</span></span>
<span class="line"><span>  tags:</span></span>
<span class="line"><span>    - vue3-app</span></span>
<span class="line"><span>  stage: build</span></span>
<span class="line"><span>  script:</span></span>
<span class="line"><span>    - npm run build</span></span>
<span class="line"><span></span></span>
<span class="line"><span>job_deploy:</span></span>
<span class="line"><span>    image: docker</span></span>
<span class="line"><span>    stage: deploy</span></span>
<span class="line"><span>    script:</span></span>
<span class="line"><span>      - docker build -t appimages</span></span>
<span class="line"><span>      - if [ $(docker ps -aq --filter name=app-container) ]; then docker rm -f app-container;fi</span></span>
<span class="line"><span>      - docker run -d -p 8082:80 --name app-container appimages</span></span></code></pre></div><p>if 语句判断：使用 docker 命令去搜索 docker 容器里面是否有一个name为 <code>app-container</code> 的容器，如果有就销毁，销毁掉是为了使用新的容器重新运行。</p><p>这里 <code>image:docker</code> 不写的话会报错：</p><p><img src="https://cdn.jsdelivr.net/gh/fqcto/images/blogs/picture/20211129170050.png" alt="image:docker"></p><p>代码推送后，流水线工作，到第三步就会出现以下报错：</p><p><img src="https://cdn.jsdelivr.net/gh/fqcto/images/blogs/picture/20211129170143.png" alt="流水线工作"></p><p><img src="https://cdn.jsdelivr.net/gh/fqcto/images/blogs/picture/20211129170247.png" alt="job_deploy报错"></p><p>解决办法，在runner配置文件中配置docker命令：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>&quot;/usr/bin/docker:/usr/bin/docker&quot;, &quot;/var/run/docker.sock:/var/run/docker.sock&quot;</span></span></code></pre></div><p>在gitlab-runner -&gt; config-vim config.toml，找到注册 runner 所对应的token，在 volumes 数组里面加入上面命令：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>concurrent = 1</span></span>
<span class="line"><span>check_interval = 0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[session_server]</span></span>
<span class="line"><span>  session_timeout = 1800</span></span>
<span class="line"><span>  </span></span>
<span class="line"><span>[[runners]]</span></span>
<span class="line"><span>  name = &quot;first-register-runner&quot;</span></span>
<span class="line"><span>  url = &quot;&quot;</span></span>
<span class="line"><span>  token = &quot;&quot;</span></span>
<span class="line"><span>  executor = &quot;docker&quot;</span></span>
<span class="line"><span>  [runners.custom_build_dir]</span></span>
<span class="line"><span>  [runners.cache]</span></span>
<span class="line"><span>    [runners.cache.s3]</span></span>
<span class="line"><span>    [runners.cache.gcs]</span></span>
<span class="line"><span>    [runners.cache.azure]</span></span>
<span class="line"><span>  [runners.docker]</span></span>
<span class="line"><span>    tls_verify = false</span></span>
<span class="line"><span>    image = &quot;alpine:latest&quot;</span></span>
<span class="line"><span>    privileged = false</span></span>
<span class="line"><span>    disable_entrypoint_overwrite = false</span></span>
<span class="line"><span>    oom_kill_disable = false</span></span>
<span class="line"><span>    disable_cache = false</span></span>
<span class="line"><span>    volumes = [&quot;/cache&quot;,&quot;/usr/bin/docker:/usr/bin/docker&quot;, &quot;/var/run/docker.sock:/var/run/docker.sock&quot;]</span></span>
<span class="line"><span>    shm_size = 0</span></span></code></pre></div><p>我们再去重新运行失败的 jobs，这时候发现成功了：</p><p><img src="https://cdn.jsdelivr.net/gh/fqcto/images/blogs/picture/20211129170528.png" alt="运行成功"></p><p>然后通过前面注册的端口号去注册，可以正常访问项目。</p><h3 id="资料参考" tabindex="-1">资料参考 <a class="header-anchor" href="#资料参考" aria-label="Permalink to &quot;资料参考&quot;">​</a></h3><p><a href="https://zhuanlan.zhihu.com/p/184936276" target="_blank" rel="noreferrer">Gitlab-ci：从零开始的前端自动化部署 - 知乎</a></p><p><a href="https://www.cnblogs.com/yuyoho/p/13274533.html" target="_blank" rel="noreferrer">在CentOS上安装GitLab-CI以及运行Runner的方法步骤</a></p><p><a href="https://www.cnblogs.com/yuyoho/p/13273794.html" target="_blank" rel="noreferrer">在Gitlab上使用CI/CD实现程序自动化部署</a></p></div></div></main><footer class="VPDocFooter" data-v-39a288b8 data-v-09de1c0f><!--[--><!--]--><!----><nav class="prev-next" data-v-09de1c0f><div class="pager" data-v-09de1c0f><a class="VPLink link pager-link prev" href="/content/Tools/Picgo/" data-v-09de1c0f><!--[--><span class="desc" data-v-09de1c0f>Previous page</span><span class="title" data-v-09de1c0f>PicGo图床</span><!--]--></a></div><div class="pager" data-v-09de1c0f><a class="VPLink link pager-link next" href="/content/Tools/BTQL/" data-v-09de1c0f><!--[--><span class="desc" data-v-09de1c0f>Next page</span><span class="title" data-v-09de1c0f>宝塔面板+青龙面板</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"content_electron_index.md\":\"eCER7_aV\",\"content_http_index.md\":\"DO1JnYN0\",\"content_performance_index.md\":\"DLVM_u61\",\"content_problem_index.md\":\"DwafhNPc\",\"content_react_index.md\":\"BHiJUqZv\",\"content_principle_index.md\":\"CrTO-Td_\",\"content_concept_index.md\":\"iidvSvwL\",\"content_css_index.md\":\"CMJ7CkRV\",\"content_javascript_index.md\":\"Bd8al7_t\",\"content_source_index.md\":\"CzFNVx_F\",\"content_tools_btql_index.md\":\"DALntyYY\",\"content_tools_picgo_index.md\":\"BQDTHL9E\",\"content_tools_cicd_index.md\":\"DNVLEnYu\",\"content_source_vue_internal_index.md\":\"walHxCpM\",\"index.md\":\"DVIahu4Y\",\"content_source_javascript_index.md\":\"DQaclLfE\",\"content_operation_index.md\":\"CdSwYzS9\",\"guide_index.md\":\"qo4h5-DX\",\"content_source_vue_vue2_index.md\":\"BGEaRUFH\",\"content_webpack_index.md\":\"1dtNHaKV\",\"content_vue_index.md\":\"BYtltb9W\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"blogs\",\"description\":\"专注于前端技术的总结，努力做一名知识的传播者\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"关于我\",\"items\":[{\"text\":\"组件库\",\"link\":\"https://canuse-ui.github.io/canuse\"}]}],\"sidebar\":[{\"text\":\"show all page\",\"items\":[{\"text\":\"Guide\",\"link\":\"/guide/\"},{\"text\":\"JavaScript\",\"link\":\"/content/JavaScript/\"},{\"text\":\"CSS\",\"link\":\"/content/Css/\"},{\"text\":\"Vue\",\"link\":\"/content/Vue/\"},{\"text\":\"React\",\"link\":\"/content/React/\"},{\"text\":\"Webpack\",\"link\":\"/content/Webpack/\"},{\"text\":\"Electron\",\"link\":\"/content/Electron/\"},{\"text\":\"HTTP\",\"link\":\"/content/Http/\"},{\"text\":\"概念详解\",\"link\":\"/content/Concept/\"},{\"text\":\"原理分析\",\"link\":\"/content/Principle/\"},{\"text\":\"性能优化\",\"link\":\"/content/Performance/\"},{\"text\":\"疑难杂症\",\"link\":\"/content/Problem/\"},{\"text\":\"源码\",\"items\":[{\"text\":\"Javascript\",\"link\":\"/content/Source/Javascript/\"},{\"text\":\"Vue2源码学习\",\"link\":\"/content/Source/Vue/Vue2/\"},{\"text\":\"vue内部运行机制\",\"link\":\"/content/Source/Vue/Internal/\"}]},{\"text\":\"工具\",\"items\":[{\"text\":\"PicGo图床\",\"link\":\"/content/Tools/Picgo/\"},{\"text\":\"CI/CD\",\"link\":\"/content/Tools/CICD/\"},{\"text\":\"宝塔面板+青龙面板\",\"link\":\"/content/Tools/BTQL/\"}]}]}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/vuejs/vitepress\"}]},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>